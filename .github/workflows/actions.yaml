name: build
on: push

defaults:
  run:
    shell: bash

jobs:
  compile-and-test:

    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Prepare Java
        uses: actions/setup-java@v1
        with:
          java-version: 1.8
      - name: Install clojure tools-deps
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.10.1.693
      - name: Compile
        run: make
      - name: Test
        run: echo "OUTPUT=$(clojure -A:test -m kaocha.runner "$@" | tail -1)" >> $GITHUB_ENV
      - name: Set Error Counter
        run: echo "ERROR_COUNTER=$(echo $OUTPUT | rev | cut -d" " -f1 | rev)" >> $GITHUB_ENV
      - name: Test Failure
        run: echo "Test(s) failed"
        if: env.ERROR_COUNTER != '0'
  # May be worth checking out again
  #run-tests:
  #  runs-on: ubuntu-latest
  #  steps:
  #    - uses: liquidz/babashka-test-action@v1
  #      with:
  #        source-paths: 'src'
  #        test-paths: 'test/matr_core'
  #        test-file-pattern: '_test.clj$'
