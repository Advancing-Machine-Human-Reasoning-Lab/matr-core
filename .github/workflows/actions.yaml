name: compile-on-push
on: push

defaults:
  run:
    shell: bash

jobs:
  compile:

    runs-on: ubuntu-latest
    # Credit to DeLaGuardo for this GitHub Action
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Prepare Java
        uses: actions/setup-java@v1
        with:
          java-version: 1.8
      - name: Install clojure tools-deps
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.10.1.693
      - name: Compile
        run: make
      - id: fetch-latest-release
        uses: thebritican/fetch-latest-release@v1
        with:
          github_token: ${{ github.token }}
      - name: Bump release version
        id: bump_version
        uses: christian-draeger/increment-semantic-version@1.0.2
        with:
          current-version: ${{ steps.fetch-latest-release.outputs.tag_name }}
          # More clever logic could potentially be used here to automate the
          # process of determining 'bug' vs. 'feature' vs. 'major'
          version-fragment: 'bug'
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.bump_version.outputs.next-version }}
          release_name: Release ${{ steps.bump_version.outputs.next-version }}
          draft: false
          prerelease: false
      - name: Upload Release Asset
        id: upload-release-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: target/uberjar/matr.jar
          asset_name: matr.jar
          asset_content_type: application/jar
      #- uses: EndBug/add-and-commit@v5
        #with:
          #add: 'target/uberjar/matr.jar'
        #env:
          #GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        #- name: Add Uberjar
      #  run: git add -f target/uberjar/matr.jar
      #- name: Commit Uberjar
        # Use same commit message as push that triggered github action
      #  run: git commit -m "auto compile new uberjar"
      #- name: Fetch from master
      #  run: git fetch origin master
      #- name: Push code to master
      #  run: git push origin HEAD:master
